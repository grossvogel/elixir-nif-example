# NifExample

An example project showing how to write your own NIF in Rust. We'll do this directly inside our Elixir project, though in practice a set of NIFs will usually be shipped as a library.

I googled a bit to find a thing that could potentially be useful, and could potentially be performance sensitive, and was implemented in Rust but not (AFAIK) in Elixir. I found https://github.com/nickbabcock/highway-rs, which is an implementation of https://github.com/google/highwayhash.

Since this is just an example, I went into the tests of the Rust library to find a usage example we could follow in order to run some code and validate it's doing what we want. I chose [this test case](https://github.com/nickbabcock/highway-rs/blob/master/tests/hash.rs#L4-L8).


## Process

### Prerequisites
- Need Elixir and Rust installed. Both are available from `asdf`

### 1. Install Rustler

Add dependency:
```elixir
  {:rustler, "~> 0.26.0"}
```

Install:
```shell
mix deps.get
mix compile
```

Check out the Rustler generator's help docs:
```shell
$ mix help rustler.new

                                 mix rustler.new

Generates boilerplate for a new Rustler project.

Usage:

    mix rustler.new [--module <Module>] [--name <Name>] [--otp-app <OTP App>]

Location: _build/dev/lib/rustler/ebin
```


### 2. Generate a new Rustler module
```
mix rustler.new --module NifExample.HighwayHash --name highway_hash --otp-app nif_example
```


### 3. Create an Elixir module to interface with the Rust code
See `lib/nif_example/highway_hash.ex`, and note that the README generated by Rustler inside `native/` has instructions for this also.


### 4. Import the highway_hash Rust module and write a wrapper

This took some flailing, but I eventually got it to work. The hard part was understanding the Rust types involved and the mechanisms by which those are translated to / from Elixir / Erlang types.

In order to stick to types that would be automatically translated by Rustler's default behavior, I ended up with these types:

|       | Elixir Type | Rust Type |
| ----- | ----------- | --------- |
| input | String.t()  | String    |
| ouput | integer()   | u64       |

To make that work with the Highway Hash library, the only missing piece was to discover that [String#as_bytes](https://doc.rust-lang.org/std/string/struct.String.html#method.as_bytes) would give me the `&[u8]` type expected by the Highway Hash function I wanted to call.

- Update `native/Cargo.toml` to bring in the `highway` dependency
- Replace the code in `native/highway_hash/src/lib.rs` with a call to the HighwayHash function


### 5. Maybe it works?
```
mix compile
mix test
```


## References
- https://github.com/google/highwayhash
- https://github.com/nickbabcock/highway-rs/blob/master/tests/hash.rs#L4
- https://crates.io/crates/highway
- https://hexdocs.pm/rustler/readme.html
- https://github.com/rusterlium/rustler/issues/363
- https://rustler-web.onrender.com/docs/cheat-sheet
- https://stackoverflow.com/questions/41034635/how-do-i-convert-between-string-str-vecu8-and-u8
